{{/*
  Disqus Comments
  基于第三方服务的评论系统
  
  参考: hexo-theme-fluid/layout/_partials/comments/disqus.ejs
  文档: https://disqus.com/
  
  配置示例 (params.toml):
  [disqus]
  shortname = "your-disqus-shortname"
  # 以下为 DisqusJS 支持（可选）
  disqusjs = false
  apikey = ["KEY1", "KEY2"]
  api = "https://disqus.skk.moe/disqus/"
  admin = ""
  adminLabel = ""
*/}}

{{ with .Site.Params.disqus }}
  {{/* 检查必要配置 */}}
  {{ if .shortname }}
    <div class="disqus" style="width: 100%;">
      <div id="disqus_thread"></div>
      
      {{ if .disqusjs }}
        {{/*
          DisqusJS 模式
          适用于国内用户，通过 API 代理访问 Disqus
          文档: https://github.com/SukkaW/DisqusJS
        */}}
        <script>
          (function() {
            function loadDisqusJS() {
              var container = document.getElementById('disqus_thread');
              if (!container) return;
              
              // 加载 DisqusJS CSS
              var link = document.createElement('link');
              link.rel = 'stylesheet';
              link.href = '{{ $.Site.Params.static_prefix.disqusjs | default "https://lib.baomitu.com/disqusjs/1.3.0/" }}disqusjs.css';
              document.head.appendChild(link);
              
              // 加载 DisqusJS JS
              var script = document.createElement('script');
              script.src = '{{ $.Site.Params.static_prefix.disqusjs | default "https://lib.baomitu.com/disqusjs/1.3.0/" }}disqus.js';
              script.onload = function() {
                new DisqusJS({
                  shortname: '{{ .shortname }}',
                  {{ with .apikey }}
                  apikey: {{ . | jsonify }},
                  {{ end }}
                  {{ with .api }}
                  api: '{{ . }}',
                  {{ end }}
                  url: '{{ $.Permalink }}',
                  identifier: '{{ $.RelPermalink }}',
                  {{ with .admin }}
                  admin: '{{ . }}',
                  {{ end }}
                  {{ with .adminLabel }}
                  adminLabel: '{{ . }}'
                  {{ end }}
                });
              };
              document.body.appendChild(script);
            }
            
            // 使用 Intersection Observer 懒加载评论
            if ('IntersectionObserver' in window) {
              var commentObserver = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                  if (entry.isIntersecting) {
                    loadDisqusJS();
                    commentObserver.disconnect();
                  }
                });
              }, { rootMargin: '200px' });
              
              var disqusContainer = document.getElementById('disqus_thread');
              if (disqusContainer) {
                commentObserver.observe(disqusContainer);
              }
            } else {
              loadDisqusJS();
            }
          })();
        </script>
      {{ else }}
        {{/*
          标准 Disqus 模式
        */}}
        <script>
          (function() {
            var disqus_config = function() {
              this.page.url = '{{ $.Permalink }}';
              this.page.identifier = '{{ $.RelPermalink }}';
            };
            
            function loadDisqus() {
              var container = document.getElementById('disqus_thread');
              if (!container) return;
              
              // 如果已经加载过，不重复加载
              if (window.DISQUS) return;
              
              var d = document, s = d.createElement('script');
              s.src = 'https://{{ .shortname }}.disqus.com/embed.js';
              s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
            }
            
            // 使用 Intersection Observer 懒加载评论
            if ('IntersectionObserver' in window) {
              var commentObserver = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                  if (entry.isIntersecting) {
                    loadDisqus();
                    commentObserver.disconnect();
                  }
                });
              }, { rootMargin: '200px' });
              
              var disqusContainer = document.getElementById('disqus_thread');
              if (disqusContainer) {
                commentObserver.observe(disqusContainer);
              }
            } else {
              loadDisqus();
            }
          })();
        </script>
      {{ end }}
      
      <noscript>
        Please enable JavaScript to view the 
        <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
      </noscript>
    </div>
  {{ end }}
{{ end }}
