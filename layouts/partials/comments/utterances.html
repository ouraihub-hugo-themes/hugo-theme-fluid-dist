{{/*
  Utterances Comments
  基于 GitHub Issues 的评论系统
  
  参考: hexo-theme-fluid/layout/_partials/comments/utterances.ejs
  文档: https://utteranc.es/
  
  配置示例 (params.toml):
  [utterances]
  repo = "your-username/your-repo"
  issue_term = "pathname"
  label = "utterances"
  theme = "github-light"
  theme_dark = "github-dark"
*/}}

{{ with .Site.Params.utterances }}
  {{/* 检查必要配置 */}}
  {{ if and .repo .issue_term }}
    {{/* Utterances 容器 */}}
    <div id="utterances" class="utterances"></div>
    
    {{/* 获取主题配置 */}}
    {{ $themeLight := .theme | default "github-light" }}
    {{ $themeDark := .theme_dark | default "github-dark" }}
    
    {{/* Utterances 加载脚本 */}}
    <script>
      (function() {
        // 主题配置
        var themeLight = '{{ $themeLight }}';
        var themeDark = '{{ $themeDark }}';
        
        // 保存主题配置到全局变量，供主题切换时使用
        window.UtterancesThemeLight = themeLight;
        window.UtterancesThemeDark = themeDark;
        
        // 获取当前主题
        function getCurrentTheme() {
          var scheme = document.documentElement.getAttribute('data-user-color-scheme');
          return scheme === 'dark' ? themeDark : themeLight;
        }
        
        // 加载 Utterances
        function loadUtterances() {
          var container = document.getElementById('utterances');
          if (!container) return;
          
          // 如果已经加载过，不重复加载
          if (container.querySelector('script[src*="utteranc.es"]')) return;
          
          var script = document.createElement('script');
          script.src = 'https://utteranc.es/client.js';
          script.crossOrigin = 'anonymous';
          script.async = true;
          
          // 设置 Utterances 属性
          script.setAttribute('repo', '{{ .repo }}');
          script.setAttribute('issue-term', '{{ .issue_term }}');
          {{ with .label }}
          script.setAttribute('label', '{{ . }}');
          {{ end }}
          script.setAttribute('theme', getCurrentTheme());
          
          container.appendChild(script);
        }
        
        // 更新 Utterances 主题
        function updateUtterancesTheme() {
          var iframe = document.querySelector('.utterances-frame');
          if (iframe) {
            var theme = getCurrentTheme();
            iframe.contentWindow.postMessage(
              { type: 'set-theme', theme: theme },
              'https://utteranc.es'
            );
          }
        }
        
        // 监听主题变化
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'data-user-color-scheme') {
              updateUtterancesTheme();
            }
          });
        });
        
        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['data-user-color-scheme']
        });
        
        // 使用 Intersection Observer 懒加载评论
        if ('IntersectionObserver' in window) {
          var commentObserver = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                loadUtterances();
                commentObserver.disconnect();
              }
            });
          }, { rootMargin: '200px' });
          
          var utterancesContainer = document.getElementById('utterances');
          if (utterancesContainer) {
            commentObserver.observe(utterancesContainer);
          }
        } else {
          // 不支持 IntersectionObserver 时直接加载
          loadUtterances();
        }
      })();
    </script>
    
    <noscript>Please enable JavaScript to view the comments powered by Utterances.</noscript>
  {{ end }}
{{ end }}
