{{/*
  Giscus Comments
  基于 GitHub Discussions 的评论系统
  
  参考: hexo-theme-fluid/layout/_partials/comments/giscus.ejs
  文档: https://giscus.app/
  
  配置示例 (params.toml):
  [giscus]
  repo = "your-username/your-repo"
  repo-id = "your-repo-id"
  category = "Announcements"
  category-id = "your-category-id"
  mapping = "pathname"
  reactions-enabled = "1"
  emit-metadata = "0"
  input-position = "top"
  theme-light = "light"
  theme-dark = "dark"
  lang = "zh-CN"
*/}}

{{ with .Site.Params.giscus }}
  {{/* 检查必要配置 */}}
  {{ if and .repo (index . "repo-id") }}
    {{/* Giscus 容器 */}}
    <div id="giscus" class="giscus"></div>
    
    {{/* 获取主题配置 */}}
    {{ $themeLight := index . "theme-light" | default "light" }}
    {{ $themeDark := index . "theme-dark" | default "dark" }}
    
    {{/* Giscus 加载脚本 */}}
    <script>
      (function() {
        // 主题配置
        var themeLight = '{{ $themeLight }}';
        var themeDark = '{{ $themeDark }}';
        
        // 保存主题配置到全局变量，供主题切换时使用
        window.GiscusThemeLight = themeLight;
        window.GiscusThemeDark = themeDark;
        
        // 获取当前主题
        function getCurrentTheme() {
          var scheme = document.documentElement.getAttribute('data-user-color-scheme');
          return scheme === 'dark' ? themeDark : themeLight;
        }
        
        // 加载 Giscus
        function loadGiscus() {
          var container = document.getElementById('giscus');
          if (!container) return;
          
          // 如果已经加载过，不重复加载
          if (container.querySelector('script[src*="giscus.app"]')) return;
          
          var script = document.createElement('script');
          script.src = 'https://giscus.app/client.js';
          script.crossOrigin = 'anonymous';
          script.async = true;
          
          // 设置 Giscus 属性
          script.setAttribute('data-repo', '{{ .repo }}');
          script.setAttribute('data-repo-id', '{{ index . "repo-id" }}');
          {{ with .category }}
          script.setAttribute('data-category', '{{ . }}');
          {{ end }}
          {{ with index . "category-id" }}
          script.setAttribute('data-category-id', '{{ . }}');
          {{ end }}
          script.setAttribute('data-mapping', '{{ .mapping | default "pathname" }}');
          script.setAttribute('data-strict', '{{ .strict | default "0" }}');
          script.setAttribute('data-reactions-enabled', '{{ index . "reactions-enabled" | default "1" }}');
          script.setAttribute('data-emit-metadata', '{{ index . "emit-metadata" | default "0" }}');
          script.setAttribute('data-input-position', '{{ index . "input-position" | default "top" }}');
          script.setAttribute('data-theme', getCurrentTheme());
          script.setAttribute('data-lang', '{{ .lang | default "en" }}');
          {{ with .loading }}
          script.setAttribute('data-loading', '{{ . }}');
          {{ end }}
          
          container.appendChild(script);
        }
        
        // 更新 Giscus 主题
        function updateGiscusTheme() {
          var iframe = document.querySelector('iframe.giscus-frame');
          if (iframe) {
            var theme = getCurrentTheme();
            iframe.contentWindow.postMessage(
              { giscus: { setConfig: { theme: theme } } },
              'https://giscus.app'
            );
          }
        }
        
        // 监听主题变化
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'data-user-color-scheme') {
              updateGiscusTheme();
            }
          });
        });
        
        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['data-user-color-scheme']
        });
        
        // 使用 Intersection Observer 懒加载评论
        if ('IntersectionObserver' in window) {
          var commentObserver = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                loadGiscus();
                commentObserver.disconnect();
              }
            });
          }, { rootMargin: '200px' });
          
          var giscusContainer = document.getElementById('giscus');
          if (giscusContainer) {
            commentObserver.observe(giscusContainer);
          }
        } else {
          // 不支持 IntersectionObserver 时直接加载
          loadGiscus();
        }
      })();
    </script>
    
    <noscript>Please enable JavaScript to view the comments powered by Giscus.</noscript>
  {{ end }}
{{ end }}
