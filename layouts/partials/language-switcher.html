{{- /*
Language Switcher Component - Using Reusable Dropdown
语言切换组件 - 使用通用下拉菜单组件

功能：
- 显示当前语言的简短标识
- 桌面端悬浮显示，移动端点击展开
- 列出所有可用语言
- 如果有翻译，链接到翻译页面
- 如果没有翻译，跳转到目标语言首页

改进：
- 使用通用 dropdown 组件
- 统一交互体验
- 改善移动端体验
*/ -}}

{{- if hugo.IsMultilingual -}}
  {{- /* 获取当前语言的简短标识 */ -}}
  {{- $currentLang := .Language.Lang -}}
  {{- $currentDisplay := "" -}}
  {{- if or (eq $currentLang "zh-CN") (eq $currentLang "zh-cn") (eq $currentLang "zh") -}}
    {{- $currentDisplay = "简" -}}
  {{- else if or (eq $currentLang "zh-TW") (eq $currentLang "zh-tw") (eq $currentLang "tw") -}}
    {{- $currentDisplay = "繁" -}}
  {{- else if or (eq $currentLang "zh-HK") (eq $currentLang "zh-hk") -}}
    {{- $currentDisplay = "港" -}}
  {{- else if or (eq $currentLang "ja") (hasPrefix $currentLang "ja") -}}
    {{- $currentDisplay = "日" -}}
  {{- else if or (eq $currentLang "en") (hasPrefix $currentLang "en") -}}
    {{- $currentDisplay = "EN" -}}
  {{- else if or (eq $currentLang "de") (hasPrefix $currentLang "de") -}}
    {{- $currentDisplay = "DE" -}}
  {{- else if or (eq $currentLang "es") (hasPrefix $currentLang "es") -}}
    {{- $currentDisplay = "ES" -}}
  {{- else if or (eq $currentLang "ru") (hasPrefix $currentLang "ru") -}}
    {{- $currentDisplay = "RU" -}}
  {{- else if or (eq $currentLang "eo") (hasPrefix $currentLang "eo") -}}
    {{- $currentDisplay = "EO" -}}
  {{- else -}}
    {{- $currentDisplay = upper $currentLang -}}
  {{- end -}}

  {{- /* 构建下拉菜单项 */ -}}
  {{- $items := slice -}}
  {{- range .Site.Languages -}}
    {{- $targetLang := .Lang -}}
    {{- $langName := .LanguageName -}}
    
    {{- /* 获取语言简短标识 */ -}}
    {{- $langDisplay := "" -}}
    {{- if or (eq $targetLang "zh-CN") (eq $targetLang "zh-cn") (eq $targetLang "zh") -}}
      {{- $langDisplay = "简" -}}
    {{- else if or (eq $targetLang "zh-TW") (eq $targetLang "zh-tw") (eq $targetLang "tw") -}}
      {{- $langDisplay = "繁" -}}
    {{- else if or (eq $targetLang "zh-HK") (eq $targetLang "zh-hk") -}}
      {{- $langDisplay = "港" -}}
    {{- else if or (eq $targetLang "ja") (hasPrefix $targetLang "ja") -}}
      {{- $langDisplay = "日" -}}
    {{- else if or (eq $targetLang "en") (hasPrefix $targetLang "en") -}}
      {{- $langDisplay = "EN" -}}
    {{- else if or (eq $targetLang "de") (hasPrefix $targetLang "de") -}}
      {{- $langDisplay = "DE" -}}
    {{- else if or (eq $targetLang "es") (hasPrefix $targetLang "es") -}}
      {{- $langDisplay = "ES" -}}
    {{- else if or (eq $targetLang "ru") (hasPrefix $targetLang "ru") -}}
      {{- $langDisplay = "RU" -}}
    {{- else if or (eq $targetLang "eo") (hasPrefix $targetLang "eo") -}}
      {{- $langDisplay = "EO" -}}
    {{- else -}}
      {{- $langDisplay = upper $targetLang -}}
    {{- end -}}
    
    {{- /* 确定链接目标 */ -}}
    {{- $targetURL := "" -}}
    {{- $isCurrentLang := eq $targetLang $.Language.Lang -}}
    
    {{- if not $isCurrentLang -}}
      {{- /* 检查是否有翻译版本 */ -}}
      {{- $hasTranslation := false -}}
      {{- range $.Translations -}}
        {{- if eq .Language.Lang $targetLang -}}
          {{- $targetURL = .RelPermalink -}}
          {{- $hasTranslation = true -}}
        {{- end -}}
      {{- end -}}
      
      {{- /* 如果没有翻译，跳转到目标语言首页 */ -}}
      {{- if not $hasTranslation -}}
        {{- $targetURL = printf "/%s/" $targetLang -}}
      {{- end -}}
    {{- end -}}
    
    {{- /* 构建菜单项 HTML */ -}}
    {{- $itemHTML := printf `<span class="language-code">%s</span><span class="language-name">%s</span>` $langDisplay $langName -}}
    
    {{- /* 添加到菜单项列表 */ -}}
    {{- if $isCurrentLang -}}
      {{- $items = $items | append (dict 
        "html" $itemHTML
        "active" true
        "class" "language-current"
      ) -}}
    {{- else -}}
      {{- $items = $items | append (dict 
        "html" $itemHTML
        "url" $targetURL
        "title" (printf "%s %s" (i18n "language.switchTo" | default "Switch to") $langName)
      ) -}}
    {{- end -}}
  {{- end -}}

  {{- /* 构建触发按钮内容 */ -}}
  {{- $triggerHTML := printf `<span class="language-code">%s</span>` $currentDisplay -}}

  {{- /* 使用通用下拉菜单组件 */ -}}
  {{ partial "components/dropdown.html" (dict 
    "trigger" $triggerHTML
    "items" $items
    "class" "language-switcher"
    "menuClass" "dropdown-menu-right"
    "id" "languageDropdown"
  ) }}
{{- end -}}
